---
title: "Orange County MBBS Results 1999-2018"
runtime: shiny
output: html_document
---

*DRAFT*


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
mbbs_dt <- readRDS(file = "mbbs_dt.rds")
library(dplyr)
library(tidyr)
library(ggplot2)
library(sparkline)
library(DT)
```

```{r data_prep}
pre_dt <- mbbs_dt %>% 
  filter(!is.na(spec_code)) 

# remove species only observed in one year
analysis_species <- pre_dt %>%
  group_by(spec_code, year) %>%
  summarise(dummy = sum(count) > 1) %>%
  group_by(spec_code) %>%
  summarise(nyears = sum(dummy)) %>%
  filter(nyears > 1)

analysis_dt <- pre_dt %>%
  right_join(analysis_species, by = "spec_code") %>%
  group_by(year, common_name, sci_name, spec_code) %>%
  summarise(count = mean(count)) %>%
  ungroup() %>%
  complete(
   nesting(common_name, sci_name, spec_code),
   year = full_seq(year, 1), 
   fill = list(count = 0)
  ) 
 

tot_sp_cnt <- length(unique(pre_dt$spec_code))
ana_sp_cnt <- length(unique(analysis_dt$spec_code))
species <- unique(analysis_dt$common_name)

```

From 1999-2018, `r tot_sp_cnt` different species were observed. For these analyses, species observed in a single year were excluded, leaving `r ana_sp_cnt` for analysis of trends.

```{r functions}
plot_trend <- function(dt){
  ggplot(
    data = dt,
    aes(x = year, y = count)
  ) + geom_line() +
    geom_point(size = 1) + 
    scale_y_continuous(
      "Mean count per route",
      expand = c(0, 0),
      limits = c(0, max(dt$count) + 1)
    ) + 
    scale_x_continuous(
      "Year",
      expand = c(.01, 0),
      breaks = seq(2000, 2018, by = 2) 
    ) + 
    stat_smooth(method = "lm", se = FALSE) +
    theme_classic() + 
    theme()
}

convert_img <- function(plot, width, height){
  tmpFile <- tempfile(fileext = ".png")
  ggsave(filename = tmpFile, plot = plot, width = width, height = height, dpi = 72)
  knitr::image_uri(tmpFile)
  
}

plot_sparkline <- function(x){
  as.character(htmltools::as.tags(
    sparkline(x,
              fillColor = FALSE,
              normalRangeMin = -diff(range(x)) * 0.09,
              normalRangeMax = diff(range(x)) * 0.09,
              spotColor      = FALSE,
              minSpotColor   = FALSE,
              maxSpotColor   = FALSE
    )))
}

```

```{r}
result_dt <- analysis_dt %>%
  group_by(common_name, sci_name, spec_code) %>%
  tidyr::nest() %>%
  mutate(
    lm             = purrr::map(data, ~ lm(count ~ year, data = .x)),
    rate_of_change = purrr::map_dbl(lm, ~ coef(.x)[2]),
    rate_of_change = round(rate_of_change, 3), 
    sparkline      = purrr::map_chr(data, ~ plot_sparkline(.x$count)),
    trend_plot     = purrr::map(data, ~ plot_trend(.x)),
    trend_plot     = purrr::map_chr(
      trend_plot, 
      ~ as.character(htmltools::img(src = convert_img(.x, width = 5.5, height = 4))))
  )

table_dt <- result_dt %>%
  select(`Common name` = common_name, `Trend` = sparkline, 
         `Rate of change` = rate_of_change, trend_plot)
```

```{r}
tab <- datatable(
  cbind(' ' = '&oplus;', table_dt), 
  escape = FALSE,
  options = list(
    paging     = FALSE,
    bInfo      = FALSE,
    columnDefs = list(
      list(visible = FALSE, targets = c(0, 5)),
      list(orderable = FALSE, className = 'details-control', targets = c(1, 5))
    )
  ),
  callback = JS("
  table.column(1).nodes().to$().css({cursor: 'pointer'});
  var format = function(d) {
    return d[5];
  };
  table.on('click', 'td.details-control', function() {
    var td = $(this), row = table.row(td.closest('tr'));
    if (row.child.isShown()) {
      row.child.hide();
      td.html('&oplus;');
    } else {
      row.child(format(row.data())).show();
      td.html('&CircleMinus;');
    }
  });"
)
)
tab$dependencies <- append(tab$dependencies, htmlwidgets:::getDependency("sparkline"))
```
```{r eruptions, echo=FALSE}
# inputPanel(
#   selectInput("species", label = "Select a species:",
#               choices = species, selected = species[1])
# )


renderDataTable(tab, server = TRUE)
# renderPlot({
#   analysis_dt %>% filter(common_name == input$species) %>%
#   plot_dt()
# 
# }, width = 700, height = 500)
```



